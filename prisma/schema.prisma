generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model ChatMessage {
  id         String   @id
  chatRoomId String
  senderId   String
  content    String
  createdAt  DateTime @default(now())
  ChatRoom   ChatRoom @relation(fields: [chatRoomId], references: [id], onDelete: Cascade)
  User       User     @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@index([chatRoomId], map: "idx_chatmessage_chatRoomId")
  @@index([senderId], map: "idx_chatmessage_senderId")
}

model ChatRoom {
  id          String        @id
  courseId    String
  createdAt   DateTime      @default(now())
  updatedAt   DateTime
  ChatMessage ChatMessage[]
  Course      Course        @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@index([courseId], map: "idx_chatroom_courseId")
}

model Course {
  id           String       @id
  title        String
  description  String?
  instructorId String?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime
  ChatRoom     ChatRoom[]
  User         User?        @relation(fields: [instructorId], references: [id])
  Enrollment   Enrollment[]

  @@index([instructorId], map: "idx_course_instructorId")
  @@index([title], map: "idx_course_title")
}

model Enrollment {
  id        String   @id
  userId    String
  courseId  String
  status    String   @default("ACTIVE")
  createdAt DateTime @default(now())
  Course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([courseId], map: "idx_enrollment_courseId")
  @@index([userId], map: "idx_enrollment_userId")
}

model RolePermission {
  id         String     @id
  role       UserRole
  permission Permission

  @@unique([role, permission])
  @@index([permission], map: "idx_rolepermission_permission")
  @@index([role], map: "idx_rolepermission_role")
}

model User {
  id          String        @id @default(cuid())
  email       String        @unique
  name        String?
  role        UserRole      @default(STUDENT)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime
  ChatMessage ChatMessage[]
  Course      Course[]
  Enrollment  Enrollment[]
  UserAction  UserAction[]

  @@index([role], map: "idx_user_role")
}

model UserAction {
  id         String   @id
  userId     String
  actionType String
  metadata   Json?
  createdAt  DateTime @default(now())
  User       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([actionType], map: "idx_useraction_actionType")
  @@index([userId], map: "idx_useraction_userId")
}

enum Permission {
  CREATE_COURSE
  EDIT_COURSE
  DELETE_COURSE
  VIEW_COURSE
  SUBMIT_ASSIGNMENT
  GRADE_ASSIGNMENT
  VIEW_ANALYTICS
  MANAGE_USERS
}

enum UserRole {
  ADMIN
  INSTRUCTOR
  STUDENT
}
